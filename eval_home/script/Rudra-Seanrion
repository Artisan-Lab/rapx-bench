#!/bin/bash
set -e

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <harness_dir>"
    echo "Error: Exactly one argument is required."
    exit 1
fi

HARNESS_DIR=$(realpath "$1")

# Check if $HARNESS_DIR is a directory
if [ ! -d "$HARNESS_DIR" ]; then
    echo "Error: '$HARNESS_DIR' is not a directory or does not exist."
    exit 1
fi

# Check if $HARNESS_DIR contains Cargo.toml
if [ ! -f "$HARNESS_DIR/Cargo.toml" ]; then
    echo "Error: Directory '$HARNESS_DIR' does not contain a Cargo.toml file."
    exit 1
fi


CARGO_CMD='cargo +nightly-2024-06-20'
export RUDRA_RUST_CHANNEL=nightly-2024-06-20
export RUDRA_RUNNER_HOME="$HOME/code/eval_home/tools/rudra-home-2024"
export RUSTFLAGS="-Awarnings -L $HOME/.rustup/toolchains/${RUDRA_RUST_CHANNEL}-x86_64-unknown-linux-gnu/lib"
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:$HOME/.rustup/toolchains/${RUDRA_RUST_CHANNEL}-x86_64-unknown-linux-gnu/lib"

cd "$HARNESS_DIR"

$CARGO_CMD clean -q

$CARGO_CMD rudra-seanrion 2>&1