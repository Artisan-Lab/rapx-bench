#!/bin/bash
set -e

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <harness_dir>"
    echo "Error: Exactly one argument is required."
    exit 1
fi

HARNESS_DIR=$(realpath "$1")

# Check if $HARNESS_DIR is a directory
if [ ! -d "$HARNESS_DIR" ]; then
    echo "Error: '$HARNESS_DIR' is not a directory or does not exist."
    exit 1
fi

# Check if $HARNESS_DIR contains Cargo.toml
if [ ! -f "$HARNESS_DIR/Cargo.toml" ]; then
    echo "Error: Directory '$HARNESS_DIR' does not contain a Cargo.toml file."
    exit 1
fi

# export RUSTFLAGS="-Awarnings"
# export LD_LIBRARY_PATH=/home/varixer/.rustup/toolchains/nightly-2020-12-29-x86_64-unknown-linux-gnu/lib:$LD_LIBRARY_PATH
CARGO_CMD='cargo +nightly-2020-12-29 -q'

cd "$HARNESS_DIR"

elements=(interval octagon polyhedra linear_equalities ppl_polyhedra ppl_linear_congruences pkgrid_polyhedra_linear_congruences)

for E in "${elements[@]}"; do
    # echo "Processing element: $E"
    $CARGO_CMD clean
    $CARGO_CMD mir-checker -q -- --entry main --widening_delay 5 --narrowing_iteration 5 --domain "$E"
done